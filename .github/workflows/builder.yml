name: Constructor Unit
run-name: ${{ github.event.client_payload.creator_username }} has spawned a new constructor unit 🔨

on:
  repository_dispatch:
    types:
      - new_repository_created


jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v2
        #with:
        #  repository: 'lettdigital/terraform-team-web'
        #  ref: 'main'
        #  path: terraform-directory
        #  token: ${{ secrets.MY_GITHUB_TOKEN }}
        #uses: actions/checkout@v2

      - name: Mapping repositories 🗺️
        id: read-json
        run: |
          json_content=$(cat repositories.json)
          echo "{repositories}={json_content}" >> $GITHUB_STATE
      
      - name: Searching for Terraform Repo 🔎
        id: find-terraform-repo
        run: |
          tag_to_find="${{ github.event.client_payload.tags.team }}"
          echo "{repositories}=${repositories}" >> "$GITHUB_OUTPUT"
          echo "{tag_to_find}=${tag_to_find}" >> "$GITHUB_OUTPUT"


          repo=""

          for row in $(echo "${repositories}" | jq -r '.[] | @base64'); do
            _jq() {
              echo ${row} | base64 --decode | jq -r ${1}
            }

            tag=$(_jq '.tag')
            if [[ "${tag}" == "${tag_to_find}" ]]; then
              repo=$(_jq '.repo')
              break
            fi
          done

          echo "::set-output name=terraform_repo::${repo}"